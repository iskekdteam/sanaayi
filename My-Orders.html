<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sanaayi | Ø·Ù„Ø¨Ø§ØªÙŠ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #ff5a00; --bg: #f8f9fa; }
        body { 
    font-family: 'Segoe UI', sans-serif; 
    background: var(--bg); /* Ø¬Ø¹Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ù„ÙˆÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‡Ø§Ø¯Ø¦ */
    margin: 0; 
    height: 100vh; 
    overflow-x: hidden; /* Ù…Ù†Ø¹ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
}


 .app-frame {
    background: var(--bg); 
    width: 100%; 
    max-width: 100%; /* Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙŠÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
    min-height: 100vh; /* Ø¬Ø¹Ù„ Ø§Ù„Ø·ÙˆÙ„ ÙŠÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
    position: relative; 
    display: flex; 
    flex-direction: column;
    box-shadow: none; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¸Ù„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ */
    border-radius: 0; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© Ù„ÙŠØµØ¨Ø­ ØµÙØ­Ø© Ø¹Ø§Ø¯ÙŠØ© */
}



        .header { padding: 35px 25px 15px; background: white; text-align: center; border-radius: 0 0 30px 30px; }
        .header h2 { margin: 0; font-size: 20px; color: #333; }

        /* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tabs { display: flex; padding: 15px 25px; gap: 10px; }
        .tab { 
            flex: 1; padding: 10px; text-align: center; background: white; 
            border-radius: 12px; font-size: 14px; font-weight: bold; color: #888; 
            cursor: pointer; transition: 0.3s; border: 1px solid #eee;
        }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        .content { flex: 1; overflow-y: auto; padding: 10px 25px; scrollbar-width: none; }
        .content::-webkit-scrollbar { display: none; }

        /* ÙƒØ§Ø±Øª Ø§Ù„Ø·Ù„Ø¨ */
        .order-card {
            background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); border-right: 5px solid var(--primary);
        }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .order-id { font-size: 12px; color: #aaa; }
        .order-status { font-size: 12px; padding: 4px 10px; border-radius: 8px; font-weight: bold; }
        .status-active { background: #fff5f0; color: var(--primary); }
        .status-done { background: #e8f5e9; color: #28a745; }

        .order-body { display: flex; gap: 12px; align-items: center; }
      .order-icon { 
    width: 50px; height: 50px; background: #fff5f0; /* Ø®Ù„ÙÙŠØ© Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ */
    border-radius: 12px; display: flex; align-items: center; 
    justify-content: center; color: var(--primary); font-size: 20px; 
}
    .order-info h4 { margin: 0; font-size: 16px; color: #333; }
        .order-info p { margin: 3px 0 0; font-size: 13px; color: #777; }

        .order-footer { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; }
        .btn-detail { color: var(--primary); font-size: 13px; font-weight: bold; cursor: pointer; text-decoration: none; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            background: white; height: 70px; display: flex; justify-content: space-around; 
            align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-radius: 30px 30px 0 0;
        }
        .nav-item { text-align: center; color: #adb5bd; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; display: block; }
        .nav-item span { font-size: 10px; }
    </style>
</head>
<body>

<div class="app-frame">
    <div class="header">
        <h2>Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(this, 'active')">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
        <div class="tab" onclick="switchTab(this, 'history')">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
    </div>

    <div class="content" id="ordersList">
        <p style="text-align:center; color:#888; margin-top:50px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...</p>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="location.href='client.html'">
            <i class="fa-solid fa-house"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <div class="nav-item active" onclick="location.href='My-Orders.html'">
            <i class="fa-solid fa-clipboard-list"></i><span>Ø·Ù„Ø¨Ø§ØªÙŠ</span>
        </div>
        <div class="nav-item" onclick="location.href='chat.html'">
            <i class="fa-solid fa-comment-dots"></i><span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
        </div>
        <div class="nav-item" onclick="location.href='profile.html'">
            <i class="fa-solid fa-user"></i><span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBuFYQuJxjinz7_0yTCTO-0jnvjeg-iXoQ",
        authDomain: "sanaayi.firebaseapp.com",
        projectId: "sanaayi",
        storageBucket: "sanaayi.firebasestorage.app",
        messagingSenderId: "657863522339",
        appId: "1:657863522339:web:f7ad44ca81147d0d519996"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentTab = 'active';

    onAuthStateChanged(auth, (user) => {
        if (user) {
            loadOrders(user.uid);
        } else {
            window.location.href = "login.html";
        }
    });

        function loadOrders(userId) {
        const list = document.getElementById('ordersList');
        
        const q = query(
            collection(db, "orders"), 
            where("clientId", "==", userId),
            orderBy("createdAt", "desc")
        );

        onSnapshot(q, (snapshot) => {
            list.innerHTML = '';
            
            console.log("ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª! Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:", snapshot.size);

            if (snapshot.empty) {
                list.innerHTML = '<p style="text-align:center; color:#888; margin-top:50px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
                return;
            }

            snapshot.forEach((docSnap) => {
                const order = docSnap.data();
                const status = order.status;

                console.log("Ø·Ù„Ø¨ Ø±Ù‚Ù…:", docSnap.id, "Ø§Ù„Ø­Ø§Ù„Ø©:", status, "Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ:", currentTab);

                // ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±Ø· Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù€ pending ÙÙŠ 'active'
                if (currentTab === 'active') {
                    // ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·: Ø§Ø¹Ø±Ø¶ Ø£ÙŠ Ø­Ø§Ø¬Ø© Ù…Ø´ (completed Ø£Ùˆ cancelled)
                    if (status === 'completed' || status === 'cancelled') return;
                } else {
                    // ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ: Ø§Ø¹Ø±Ø¶ ÙÙ‚Ø· (completed Ø£Ùˆ cancelled)
                    if (status !== 'completed' && status !== 'cancelled') return;
                }

                const card = createOrderCard(docSnap.id, order);
                list.insertAdjacentHTML('beforeend', card);
            });

            // Ù„Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø³Ù‡ ÙØ§Ø¶ÙŠØ©
            if (list.innerHTML === '') {
                list.innerHTML = '<p style="text-align:center; color:#888; margin-top:50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>';
            }
        }, (error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²:", error);
            list.innerHTML = '<p style="color:red; text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
        });
    }


        function createOrderCard(id, order) {
        let statusText = "";
        let statusClass = "status-active";
        let footerAction = "";

        // Ø¯Ù‡ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ´Ù… Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
        switch(order.status) {
            case 'pending': 
                // Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù…Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¨Ø¹Øª Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ„Ø³Ù‡ Ù…ÙÙŠØ´ ÙÙ†ÙŠ ÙˆØ§ÙÙ‚
                statusText = "Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ ÙÙ†ÙŠ... ğŸ”"; 
                statusClass = "status-active"; // Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                footerAction = `<span style="color:#888; font-size:12px;">ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§ØªØ§Ø­Ù‡ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³ÙŠØªÙ… Ø§Ø¨Ù„Ø§Øº Ø§Ù‚Ø±Ø¨ ÙÙ†ÙŠ Ù„Ùƒ</span>`;
                break;
            
            case 'accepted': 
                statusText = "Ø§Ù„ÙÙ†ÙŠ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ ğŸšš"; 
                footerAction = `<a href="chat.html?orderId=${id}" class="btn-detail">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„ÙÙ†ÙŠ</a>`;
                break;

            case 'completed': 
                statusText = "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° âœ¨"; 
                statusClass = "status-done"; // Ù„ÙˆÙ† Ø£Ø®Ø¶Ø±
                if(!order.rating) {
                    footerAction = `<button onclick="openRating('${id}')" style="border:none; background:none; color:var(--primary); font-weight:bold; cursor:pointer;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø© â­</button>`;
                } else {
                    footerAction = `<span style="color:#28a745">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ (${order.rating}/5)</span>`;
                }
                break;
        }

        const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('ar-EG') : "";

        return `
            <div class="order-card" style="border-right-color: ${order.status === 'completed' ? '#28a745' : '#ff5a00'}">
                <div class="order-header">
                    <span class="order-id">#${id.slice(-5)}</span>
                    <span class="order-status ${statusClass}">${statusText}</span>
                </div>
                <div class="order-body">
                    <div class="order-icon"><i class="fa-solid fa-clock-rotate-left"></i></div>
                    <div class="order-info">
                        <h4>${order.serviceType || 'Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©'}</h4>
                        <p>${order.providerName || 'Ø¨Ø¥Ù†ØªØ¸Ø§Ø± Ø£ÙˆÙ„ ÙÙ†ÙŠ ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨'}</p>
                    </div>
                </div>
                <div class="order-footer">
                    <span style="font-size: 11px; color: #999;">${date}</span>
                    ${footerAction}
                </div>
            </div>
        `;
    }


    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¨Ø³Ø·Ø©
    window.openRating = async (orderId) => {
    const rating = prompt("Ù‚ÙŠÙ… Ø§Ù„ÙÙ†ÙŠ Ù…Ù† 1 Ø¥Ù„Ù‰ 5:");
    const ratingNum = parseInt(rating);

    if (ratingNum >= 1 && ratingNum <= 5) {
        try {
            // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† Ù‡Ùˆ Ø§Ù„ÙÙ†ÙŠ (providerId)
            const orderDoc = await getDoc(doc(db, "orders", orderId));
            const orderData = orderDoc.data();
            const providerId = orderData.providerId;

            if (!providerId) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ‚ÙŠÙŠÙ… Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ÙÙ†ÙŠ!");

            // 2. ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø·Ù„Ø¨ (Ø¹Ø´Ø§Ù† Ø§Ù„Ø²Ø±Ø§Ø± ÙŠØ®ØªÙÙŠ ÙˆÙŠØ¸Ù‡Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…)
            await updateDoc(doc(db, "orders", orderId), {
                rating: ratingNum,
                ratedAt: new Date()
            });

            // 3. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†ÙŠ (Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·)
            const providerRef = doc(db, "users", providerId);
            const providerDoc = await getDoc(providerRef);
            const providerData = providerDoc.data();

            // Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·:
            // (Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© + Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯) / (Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª + 1)
            const oldRating = providerData.rating || 0;
            const totalReviews = providerData.reviewsCount || 0;
            
            const newReviewsCount = totalReviews + 1;
            const newAverageRating = ((oldRating * totalReviews) + ratingNum) / newReviewsCount;

            await updateDoc(providerRef, {
                rating: parseFloat(newAverageRating.toFixed(1)), // Ø±Ù‚Ù… ÙˆØ§Ø­Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© (Ù…Ø«Ù„Ø§Ù‹ 4.8)
                reviewsCount: newReviewsCount
            });

            alert("Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù„ÙÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­.");
        } catch (e) {
            console.error("Error updating rating:", e);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….");
        }
    } else {
        alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù…Ù† 1 Ù„Ù€ 5");
    }
};


    window.switchTab = (el, type) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        currentTab = type;
        if (auth.currentUser) loadOrders(auth.currentUser.uid);
    }
</script>



</body>
</html>
